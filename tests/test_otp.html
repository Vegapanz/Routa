<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP System Test - Routa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 40px; background: #f8f9fa; }
        .test-card { background: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { color: #10b981; }
        .error { color: #dc3545; }
        .info { color: #0284c7; }
        pre { background: #f1f5f9; padding: 15px; border-radius: 5px; }
        .btn-test { margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">ðŸ§ª OTP System Testing</h1>
        
        <!-- Database Check -->
        <div class="test-card">
            <h3>1. Database Configuration</h3>
            <div id="dbCheck">Checking...</div>
        </div>
        
        <!-- Phone Validation Test -->
        <div class="test-card">
            <h3>2. Phone Number Validation</h3>
            <div class="mb-3">
                <input type="tel" class="form-control" id="testPhone" placeholder="Enter phone number" value="09123456789">
            </div>
            <button class="btn btn-primary" onclick="testPhoneValidation()">Test Validation</button>
            <div id="phoneResult" class="mt-3"></div>
        </div>
        
        <!-- Send OTP Test -->
        <div class="test-card">
            <h3>3. Send OTP Test</h3>
            <div class="mb-3">
                <input type="tel" class="form-control" id="sendOtpPhone" placeholder="Enter phone number" value="09123456789">
            </div>
            <button class="btn btn-success" onclick="testSendOtp()">Send OTP</button>
            <div id="sendOtpResult" class="mt-3"></div>
        </div>
        
        <!-- Verify OTP Test -->
        <div class="test-card">
            <h3>4. Verify OTP Test</h3>
            <div class="mb-3">
                <input type="tel" class="form-control mb-2" id="verifyPhone" placeholder="Phone number" value="+639123456789">
                <input type="text" class="form-control" id="verifyOtp" placeholder="Enter OTP code" maxlength="6">
            </div>
            <button class="btn btn-info" onclick="testVerifyOtp()">Verify OTP</button>
            <div id="verifyOtpResult" class="mt-3"></div>
        </div>
        
        <!-- Manual SQL -->
        <div class="test-card">
            <h3>5. Quick Setup</h3>
            <p>If tables don't exist, run this SQL in phpMyAdmin:</p>
            <pre>USE routa_db;

CREATE TABLE IF NOT EXISTS otp_verifications (
    id INT AUTO_INCREMENT PRIMARY KEY,
    phone VARCHAR(25) NOT NULL,
    otp_code VARCHAR(6) NOT NULL,
    is_verified TINYINT(1) DEFAULT 0,
    expires_at DATETIME NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_phone (phone),
    INDEX idx_otp_code (otp_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

ALTER TABLE users 
ADD COLUMN IF NOT EXISTS phone_verified TINYINT(1) DEFAULT 0 AFTER phone;</pre>
            <button class="btn btn-warning" onclick="location.reload()">Recheck After Running SQL</button>
        </div>
    </div>

    <script>
        // Check database on load
        window.onload = function() {
            fetch('php/test_otp_system.php')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('dbCheck').innerHTML = data;
                })
                .catch(error => {
                    document.getElementById('dbCheck').innerHTML = '<div class="error">Error loading test results</div>';
                    console.error(error);
                });
        };

        function testPhoneValidation() {
            const phone = document.getElementById('testPhone').value;
            const result = document.getElementById('phoneResult');
            
            result.innerHTML = '<div class="info">Testing phone: ' + phone + '</div>';
            
            // Test validation
            const cleaned = phone.replace(/[\s\-\(\)]/g, '');
            const patterns = [
                { pattern: /^\+639\d{9}$/, name: '+639XXXXXXXXX' },
                { pattern: /^639\d{9}$/, name: '639XXXXXXXXX' },
                { pattern: /^09\d{9}$/, name: '09XXXXXXXXX' },
                { pattern: /^9\d{9}$/, name: '9XXXXXXXXX' }
            ];
            
            let matched = false;
            patterns.forEach(p => {
                if (p.pattern.test(cleaned)) {
                    result.innerHTML += '<div class="success">âœ“ Matches pattern: ' + p.name + '</div>';
                    matched = true;
                }
            });
            
            if (!matched) {
                result.innerHTML += '<div class="error">âœ— Does not match any valid pattern</div>';
            }
            
            // Show normalized version
            let normalized = cleaned;
            if (/^09\d{9}$/.test(cleaned)) {
                normalized = '+63' + cleaned.substring(1);
            } else if (/^9\d{9}$/.test(cleaned)) {
                normalized = '+63' + cleaned;
            } else if (/^639\d{9}$/.test(cleaned)) {
                normalized = '+' + cleaned;
            }
            
            result.innerHTML += '<div class="info">Normalized: ' + normalized + '</div>';
        }

        function testSendOtp() {
            const phone = document.getElementById('sendOtpPhone').value;
            const result = document.getElementById('sendOtpResult');
            
            result.innerHTML = '<div class="info">Sending OTP to: ' + phone + '...</div>';
            
            const formData = new FormData();
            formData.append('phone', phone);
            
            fetch('php/send_otp.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Send OTP Response:', data);
                
                if (data.success) {
                    let html = '<div class="success">âœ“ OTP sent successfully!</div>';
                    html += '<div class="info">Phone: ' + data.phone + '</div>';
                    if (data.debug_otp) {
                        html += '<div class="alert alert-warning mt-2"><strong>TEST MODE - OTP Code:</strong> ' + data.debug_otp + '</div>';
                        document.getElementById('verifyPhone').value = data.phone;
                        document.getElementById('verifyOtp').value = data.debug_otp;
                    }
                    if (data.debug_info) {
                        html += '<div class="alert alert-info mt-2"><strong>Time Debug Info:</strong><br>';
                        html += 'Current Time: ' + data.debug_info.current_time + '<br>';
                        html += 'Expires At: ' + data.debug_info.expires_at + '<br>';
                        html += 'Valid for: 5 minutes</div>';
                    }
                    result.innerHTML = html;
                } else {
                    let html = '<div class="error">âœ— Failed: ' + data.message + '</div>';
                    if (data.error) {
                        html += '<div class="alert alert-danger mt-2"><strong>Error details:</strong><br>' + data.error + '</div>';
                    }
                    result.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                result.innerHTML = '<div class="error">âœ— Network error: ' + error.message + '</div>';
            });
        }

        function testVerifyOtp() {
            const phone = document.getElementById('verifyPhone').value;
            const otp = document.getElementById('verifyOtp').value;
            const result = document.getElementById('verifyOtpResult');
            
            if (!otp || otp.length !== 6) {
                result.innerHTML = '<div class="error">Please enter a 6-digit OTP</div>';
                return;
            }
            
            result.innerHTML = '<div class="info">Verifying OTP...</div>';
            
            const formData = new FormData();
            formData.append('phone', phone);
            formData.append('otp', otp);
            
            fetch('php/verify_otp.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Verify OTP Response:', data);
                
                if (data.success) {
                    result.innerHTML = '<div class="success">âœ“ OTP verified successfully!</div>';
                } else {
                    let html = '<div class="error">âœ— Verification failed: ' + data.message + '</div>';
                    if (data.error) {
                        html += '<div class="alert alert-danger mt-2">' + data.error + '</div>';
                    }
                    result.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                result.innerHTML = '<div class="error">âœ— Network error: ' + error.message + '</div>';
            });
        }
    </script>
</body>
</html>
