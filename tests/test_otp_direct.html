<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct OTP Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Direct OTP Verification Test</h2>
        
        <div class="card p-4 mb-3">
            <h4>Step 1: Send OTP</h4>
            <input type="tel" class="form-control mb-2" id="phoneInput" value="09123456789" placeholder="Phone">
            <button class="btn btn-primary" onclick="sendOTP()">Send OTP</button>
            <div id="sendResult" class="mt-2"></div>
        </div>
        
        <div class="card p-4">
            <h4>Step 2: Verify OTP</h4>
            <input type="text" class="form-control mb-2" id="phoneVerify" placeholder="Phone (will auto-fill)" readonly>
            <input type="text" class="form-control mb-2" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6">
            <button class="btn btn-success" onclick="verifyOTP()">Verify OTP</button>
            <div id="verifyResult" class="mt-2"></div>
        </div>
        
        <div class="card p-4 mt-3">
            <h4>Browser Console</h4>
            <p>Press F12 to open developer tools and check the Console tab for detailed error messages.</p>
        </div>
    </div>

    <script>
        function sendOTP() {
            const phone = document.getElementById('phoneInput').value;
            const result = document.getElementById('sendResult');
            
            result.innerHTML = '<div class="alert alert-info">Sending...</div>';
            
            fetch('php/send_otp.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'phone=' + encodeURIComponent(phone)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Send OTP Response:', data);
                
                if (data.success) {
                    document.getElementById('phoneVerify').value = data.phone;
                    
                    let html = '<div class="alert alert-success">';
                    html += '<strong>✓ OTP Sent!</strong><br>';
                    html += 'Phone: ' + data.phone + '<br>';
                    if (data.debug_otp) {
                        html += '<strong>OTP Code: ' + data.debug_otp + '</strong><br>';
                        document.getElementById('otpInput').value = data.debug_otp;
                    }
                    if (data.debug_info) {
                        html += '<small>Expires at: ' + data.debug_info.expires_at + '</small>';
                    }
                    html += '</div>';
                    result.innerHTML = html;
                } else {
                    let html = '<div class="alert alert-danger">';
                    html += '<strong>✗ Error:</strong> ' + data.message;
                    if (data.error) {
                        html += '<br><small>' + data.error + '</small>';
                    }
                    html += '</div>';
                    result.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                result.innerHTML = '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
            });
        }
        
        function verifyOTP() {
            const phone = document.getElementById('phoneVerify').value;
            const otp = document.getElementById('otpInput').value;
            const result = document.getElementById('verifyResult');
            
            if (!otp || otp.length !== 6) {
                result.innerHTML = '<div class="alert alert-warning">Please enter a 6-digit OTP</div>';
                return;
            }
            
            result.innerHTML = '<div class="alert alert-info">Verifying...</div>';
            
            fetch('php/verify_otp.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'phone=' + encodeURIComponent(phone) + '&otp=' + encodeURIComponent(otp)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Verify OTP Response:', data);
                
                if (data.success) {
                    result.innerHTML = '<div class="alert alert-success"><strong>✓ Verification Successful!</strong><br>' + data.message + '</div>';
                } else {
                    let html = '<div class="alert alert-danger">';
                    html += '<strong>✗ Verification Failed</strong><br>';
                    html += data.message;
                    if (data.error) {
                        html += '<br><br><strong>Database Error:</strong><br>';
                        html += '<code>' + data.error + '</code>';
                    }
                    if (data.debug) {
                        html += '<br><br><small>';
                        html += 'Current Time: ' + data.debug.current_time + '<br>';
                        html += 'Expiry Time: ' + data.debug.expiry_time;
                        html += '</small>';
                    }
                    html += '</div>';
                    result.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                result.innerHTML = '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
            });
        }
    </script>
</body>
</html>
